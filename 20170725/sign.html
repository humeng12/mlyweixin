<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
		<title>签到送积分</title>
		
		<link rel="stylesheet" type="text/css" href="../bootstrap/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="../bootstrap/sign.css">
		<link rel="stylesheet" href="../css/jquery-weui.min.css">
		<link rel="stylesheet" href="../common/common.css" />

		<script src="../js/jquery-2.1.4.js"></script>
		<script src="../js/jquery-weui.js"></script>
		<script src="../js/sign.js"></script>
		<script src="https://res.wx.qq.com/open/libs/weuijs/1.0.0/weui.min.js"></script>

		<script type="text/javascript">
			function initSign(year, month, signList){
				//显示当前年份和月份 生成日历的工具类
				var str = calUtil.drawCal(year,month+1,signList);
				//显示当前日历
				$("#calendar").html("").html(str);
			}
			$(function(){
				//初始化签到表，为当前月份的签到情况
				var iDate = new Date();
			    var year=iDate.getFullYear();
			    var month=iDate.getMonth();
			    var currentmonth=month+1;
			    var day=iDate.getDate();
			    var date=year+"-"+currentmonth+"-"+day;
			    $("#currDate").text(date);
   
				var signList = [date,''];
   
				initSign(iDate.getFullYear(), iDate.getMonth(), signList);
	
				//上一个月的签到情况
				$("#minusMonth").on("click", function(){
					var currDate = $("#currDate").text();
					var date = new Date(currDate);
					//0表示1月份，再减一个月就得减年份
					var year;
					var month;
					if(date.getMonth() == 0){
						year = date.getFullYear() - 1;
						month = 11;
						var signList = "";
						initSign(year, month, signList);
					}else{
						year = date.getFullYear();
						month = date.getMonth()-1;
						var signList = "";
						initSign(year, month, signList);
					}
				});
				//下一个月的签到情况
				$("#addMonth").on("click", function(){
					var currDate = $("#currDate").text();
					var date = new Date(currDate);
					//11表示12月份，再加一个月就得加年份
					var year;
					var month;
					if(date.getMonth() == 11){
						year = date.getFullYear() + 1;//年份加1
						month = 0;//月份重新赋值为0（表示1月）
						var signList = "";
						initSign(year, month, signList);
					}else{
						year = date.getFullYear();
						month = date.getMonth()+1;
						var signList = "";
						initSign(year, month, signList);
					}
				});
			});
		</script>
		<style type="text/css">
			@media screen and (min-width:1024px) {
				.rich_media {
					width: 500px;
					margin-left: auto;
					margin-right: auto;
					padding: 20px;
				}
			}
			.rich_media #page-content .header img{
			      width: 3rem;
			      height: 2rem;
			      margin-top: 0.5rem;
			}
			.header{
				width: 100%;
				height: 3rem;
				background-color: #FAFAFA;
				display: flex;
				display: -webkit-flex;
				line-height: 0.5rem;
				margin-top: 0.3rem;
			}
			.header .text{
				padding-top: 1rem;
			}
			.header .text p:nth-child(2){
				margin-top: 6px;
			}
			.container-fluid{
				margin-top: 1rem;
			}
			#calendar{
				margin-top: 0.5rem;
			}
		</style>
	</head>
	<body style="background-color: #FFFFFF;">
		
  		<header id="title" style="background-color: #FFFFFF;color: #000000;border-bottom: 1px solid #CDCDCD;">
    		<img class="goback" src="../images/jiantou.png"/>
    		签到
  		</header>
  
	    <div class="rich_media">
	        <div id="page-content">
	            <div class="header">			    
	            	<img src="../images/money.png">
	            	<div class="text">
	            		 <p>我的积分:<span>1100</span></p>
	                     <p>签到送积分</p>
	            	</div>
	            </div>
				<div class="container-fluid">
				    <div class="row-fluid">
				    	<div class='sign_succ_calendar_title'>
				    		<div class='calendar_month_span'>
				    			<span id='currDate'></span>
				    		</div>
				    	</div>
				    <div id="calendar"></div>
				</div>
			</div>
			<div class="signbutton" style="width:4rem;height: 2rem;margin:3rem auto;">
				<img src="../images/sign.png" style="width: 100%;">
			</div>
	   </div>
	</body>
</html>


<script type="text/javascript">

	$('.goback').click(function(){
		history.go(-1);
	});
	
	var signTime = localStorage.getItem('signTime');

	var datestr = getNowFormatDate();

	var data = JSON.parse(localStorage.getItem('signInfo'));

	if(data){

		if (DateDiff(datestr,signTime) == 0) {

			signed(data['signdate']);

			$('.unsign').hide();
			$('.sign').show();
		}else{
			signed(data['signdate']);
		}
	}
	  	
	$(".signbutton").click(function(){

		
		if (data) {

			if (signTime != null ) {

				if (DateDiff(datestr,signTime) == 0) {
					$.toast('今日已签到',"text");
					return;
				}
			}
		}

		var userid = localStorage.getItem('idstr'); 

        $.showLoading('签到中...');

	   	$.ajax({  
            type:'post',  
            url: 'http://47.93.217.112/shoph/1/mly/public/api/taskSign',  
			//url: 'http://humeng.ngrok.cc/laravel/1/mly/public/api/taskSign',
            data: {
                idstr:userid,
                signdate:datestr
            },
            dataType:'json',  
            async:false,  
            cache:false,                 
            success: function (result) {  

                setTimeout(function() {
							
					$.hideLoading();
					$.toast(result['message'],"text");
				},3000); 

                if(result['status']== '0'){
             		
             		localStorage.setItem('signInfo',JSON.stringify(result['data']));
             		localStorage.setItem('signTime',datestr);

                    $('.unsign').hide();
		            $('.sign').show();
		              
                }
                else{
                    	
                    $('.unsign').show();
			        $('.sign').hide();
                }
            },
            error:function(data){
            	$.hideLoading();
            	
            	$.toast('签到失败',"text");
            }
        });  
	});


	function getNowFormatDate() {

	    var date = new Date();
	    var seperator1 = "-";
	    var seperator2 = ":";
	    var month = date.getMonth() + 1;
	    var strDate = date.getDate();
	    if (month >= 1 && month <= 9) {
	        month = "0" + month;
	    }
	    if (strDate >= 0 && strDate <= 9) {
	        strDate = "0" + strDate;
	    }
	    var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate;

	    //" " + date.getHours() + seperator2 + date.getMinutes()
	            //+ seperator2 + date.getSeconds()

	    return currentdate;
	}


	function DateDiff(sDate1,   sDate2){
        var   aDate,   oDate1,   oDate2,   iDays;  
        aDate   =   sDate1.split("-");
        oDate1   =   new   Date(aDate[1]   +   '-'   +   aDate[2]   +   '-'   +   aDate[0]);
        aDate   =   sDate2.split("-"); 
        oDate2   =   new   Date(aDate[1]   +   '-'   +   aDate[2]   +   '-'   +   aDate[0]); 
        iDays   =   parseInt(Math.abs(oDate1   -   oDate2)   /   1000   /   60   /   60   /24);  
        
        return   iDays;
    }  


    function signed(signdate)
    {
		var iDate = new Date();
	   
	   	var signList = new Array();
		signList[0] = getNowFormatDate();

	   	for (var i = 0; i < signdate.length; i++) {
	   	
	   		signList[i + 1] = signdate[i]['sign_date'];
	   	}

		initSign(iDate.getFullYear(), iDate.getMonth(), signList);
    }
</script>
